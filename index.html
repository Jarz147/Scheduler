// ==========================
// Konfigurasi
// ==========================
const MAINTENANCE_INTERVAL_DAYS = 30;
const DUE_SOON_DAYS = 7;

// ==========================
// Element DOM
// ==========================
const form             = document.getElementById('machine-form');
const machineNameInput = document.getElementById('machine-name');
const lastMainInput    = document.getElementById('last-maintenance');
const machineList      = document.getElementById('machine-list');
const searchInput      = document.getElementById('search');

// ==========================
// Storage Handler
// ==========================
let machines = loadMachines();

function loadMachines() {
    try {
        return JSON.parse(localStorage.getItem('machines')) || [];
    } catch {
        console.warn("LocalStorage corrupted. Resetting.");
        localStorage.removeItem('machines');
        return [];
    }
}

function saveMachines() {
    localStorage.setItem('machines', JSON.stringify(machines));
}

// ==========================
// Helper Functions
// ==========================
function calculateNextDate(lastDate) {
    const date = new Date(lastDate);
    if (isNaN(date)) return null;

    date.setDate(date.getDate() + MAINTENANCE_INTERVAL_DAYS);
    return date.toISOString().split('T')[0];
}

function getStatus(nextDate) {
    const today = new Date();
    const next = new Date(nextDate);

    if (isNaN(next)) return { text: 'Invalid Date', class: 'status-overdue' };

    const diff = Math.ceil((next - today) / 86400000);

    if (diff < 0) return { text: 'Overdue', class: 'status-overdue' };
    if (diff <= DUE_SOON_DAYS) return { text: 'Due Soon', class: 'status-due-soon' };
    return { text: 'OK', class: 'status-ok' };
}

// ==========================
// Render Function
// ==========================
function renderMachines(filter = '') {
    machineList.innerHTML = '';

    const filtered = machines.filter(m =>
        m.name.toLowerCase().includes(filter.toLowerCase())
    );

    filtered.forEach((machine, index) => {
        const status = getStatus(machine.nextMaintenance);

        machineList.insertAdjacentHTML('beforeend', `
            <tr data-index="${index}">
                <td>${machine.name}</td>
                <td>${machine.lastMaintenance}</td>
                <td>${machine.nextMaintenance}</td>
                <td class="${status.class}">${status.text}</td>
                <td><button class="delete-btn">Delete</button></td>
            </tr>
        `);
    });
}

// ==========================
// Delete Handler (Event Delegation)
// ==========================
machineList.addEventListener('click', (e) => {
    if (e.target.classList.contains('delete-btn')) {
        const row = e.target.closest('tr');
        const index = row.dataset.index;
        machines.splice(index, 1);
        saveMachines();
        renderMachines(searchInput.value);
    }
});

// ==========================
// Overdue Check
// ==========================
function checkOverdue() {
    const overdueList = machines
        .filter(m => getStatus(m.nextMaintenance).text === 'Overdue')
        .map(m => m.name);

    if (overdueList.length) {
        alert(`âš  Overdue machines:\n${overdueList.join(', ')}`);
    }
}

// ==========================
// Form Submit Handler
// ==========================
form.addEventListener('submit', (e) => {
    e.preventDefault();

    const name = machineNameInput.value.trim();
    const lastMaintenance = lastMainInput.value;

    if (!name || !lastMaintenance) return;

    const nextMaintenance = calculateNextDate(lastMaintenance);

    const existing = machines.findIndex(
        m => m.name.toLowerCase() === name.toLowerCase()
    );

    const newData = { name, lastMaintenance, nextMaintenance };

    if (existing >= 0) {
        machines[existing] = newData;
    } else {
        machines.push(newData);
    }

    saveMachines();
    renderMachines(searchInput.value);

    form.reset();
});

// ==========================
// Search Handler
// ==========================
searchInput.addEventListener('input', () =>
    renderMachines(searchInput.value)
);

// ==========================
// Initial Load
// ==========================
renderMachines();
checkOverdue();
